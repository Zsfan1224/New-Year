<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>烟花动画</title>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      background-color: black;
    }
    #cas {
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>

  <canvas id="cas"></canvas>

  <script>
    var canvas = document.getElementById("cas");
    var ocas = document.createElement("canvas");
    var octx = ocas.getContext("2d");
    var ctx = canvas.getContext("2d");
    ocas.width = canvas.width = window.innerWidth;
    ocas.height = canvas.height = window.innerHeight;

    var bigbooms = [];
    var stars = [];
    var maxRadius = 1;
    var lastTime;

    // 用于随机生成数值的函数
    function getRandom(a, b) {
      return Math.random() * (b - a) + a;
    }

    // 启动画布
    function initAnimate() {
      drawBg();
      lastTime = new Date();
      animate();
    }

    // 动画循环
    function animate() {
      ctx.save();
      ctx.fillStyle = "rgba(0,5,24,0.1)";
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();

      var newTime = new Date();
      if (newTime - lastTime > 500 + (window.innerHeight - 767) / 2) {
        var random = Math.random() * 100 > 33 ? true : false;
        var x = getRandom(canvas.width / 5, canvas.width * 4 / 5);
        var y = getRandom(50, 200);
        if (random) {
          var bigboom = new Boom(getRandom(canvas.width / 3, canvas.width * 2 / 3), 2, "#FFF", {
            x: x,
            y: y
          });
          bigbooms.push(bigboom);
        } else {
          var bigboom = new Boom(getRandom(canvas.width / 3, canvas.width * 2 / 3), 2, "#FFF", {
            x: canvas.width / 2,
            y: 200
          });
          bigbooms.push(bigboom);
        }
        lastTime = newTime;
      }

      stars.forEach(function(star) {
        star.paint();
      });

      drawMoon();

      bigbooms.forEach(function(bigboom, index) {
        if (!bigboom.dead) {
          bigboom._move();
          bigboom._drawLight();
        } else {
          bigboom.booms.forEach(function(frag, fragIndex) {
            if (!frag.dead) {
              frag.moveTo(fragIndex);
            } else {
              if (fragIndex === bigboom.booms.length - 1) {
                bigbooms.splice(index, 1);
              }
            }
          });
        }
      });

      requestAnimationFrame(animate);
    }

    // 绘制月亮
    function drawMoon() {
      var moon = document.getElementById("moon");
      var centerX = canvas.width - 200,
          centerY = 100,
          width = 80;
      if (moon && moon.complete) {
        ctx.drawImage(moon, centerX, centerY, width, width);
      } else {
        moon.onload = function() {
          ctx.drawImage(moon, centerX, centerY, width, width);
        };
      }

      var index = 0;
      for (var i = 0; i < 10; i++) {
        ctx.save();
        ctx.beginPath();
        ctx.arc(centerX + width / 2, centerY + width / 2, width / 2 + index, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(240,219,120,0.005)";
        index += 2;
        ctx.fill();
        ctx.restore();
      }
    }

    // 星星背景
    function drawBg() {
      for (var i = 0; i < 100; i++) {
        var r = Math.random() * maxRadius;
        var x = Math.random() * canvas.width;
        var y = Math.random() * 2 * canvas.height - canvas.height;
        var star = new Star(x, y, r);
        stars.push(star);
        star.paint();
      }
    }

    // 星星构造函数
    var Star = function(x, y, r) {
      this.x = x;
      this.y = y;
      this.r = r;
    };
    Star.prototype.paint = function() {
      ctx.save();
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
      ctx.fillStyle = "rgba(255,255,255," + this.r + ")";
      ctx.fill();
      ctx.restore();
    };

    // 烟花爆炸体
    var Boom = function(x, r, c, boomArea) {
      this.booms = [];
      this.x = x;
      this.y = canvas.height + r;
      this.r = r;
      this.c = c;
      this.boomArea = boomArea;
      this.dead = false;
      this.ba = parseInt(getRandom(80, 200));
    };
    Boom.prototype = {
      _paint: function() {
        ctx.save();
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r, 0, 2 * Math.PI);
        ctx.fillStyle = this.c;
        ctx.fill();
        ctx.restore();
      },
      _move: function() {
        var dx = this.boomArea.x - this.x,
            dy = this.boomArea.y - this.y;
        this.x = this.x + dx * 0.01;
        this.y = this.y + dy * 0.01;
        if (Math.abs(dx) <= this.ba && Math.abs(dy) <= this.ba) {
          this._boom();
          this.dead = true;
        } else {
          this._paint();
        }
      },
      _drawLight: function() {
        ctx.save();
        ctx.fillStyle = "rgba(255,228,150,0.3)";
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.r + 3 * Math.random() + 1, 0, 2 * Math.PI);
        ctx.fill();
        ctx.restore();
      },
      _boom: function() {
        var fragNum = getRandom(30, 200);
        for (var i = 0; i < fragNum; i++) {
          var a = getRandom(-Math.PI, Math.PI);
          var x = getRandom(0, 400) * Math.cos(a) + this.x;
          var y = getRandom(0, 400) * Math.sin(a) + this.y;
          var radius = getRandom(0, 2);
          var color = {
            a: parseInt(getRandom(128, 255)),
            b: parseInt(getRandom(128, 255)),
            c: parseInt(getRandom(128, 255))
          };
          var frag = new Frag(this.x, this.y, radius, color, x, y);
          this.booms.push(frag);
        }
      }
    };

    // 烟花碎片
    var Frag = function(centerX, centerY, radius, color, tx, ty) {
      this.tx = tx;
      this.ty = ty;
      this.x = centerX;
      this.y = centerY;
      this.dead = false;
      this.radius = radius;
      this.color = color;
    };
    Frag.prototype = {
      paint: function() {
        ctx.save();
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, 2 * Math.PI);
        ctx.fillStyle = "rgba(" + this.color.a + "," + this.color.b + "," + this.color.c + ",1)";
        ctx.fill();
        ctx.restore();
      },
      moveTo: function() {
        this.ty = this.ty + 0.3;
        var dx = this.tx - this.x,
            dy = this.ty - this.y;
        this.x = Math.abs(dx) < 0.1 ? this.tx : (this.x + dx * 0.1);
        this.y = Math.abs(dy) < 0.1 ? this.ty : (this.y + dy * 0.1);
        if (dx === 0 && Math.abs(dy) <= 80) {
          this.dead = true;
        }
        this.paint();
      }
    };

    // 点击触发烟花
    canvas.onclick = function(event) {
      var x = event.clientX;
      var y = event.clientY;
      var bigboom = new Boom(getRandom(canvas.width / 3, canvas.width * 2 / 3), 2, "#FFF", {
        x: x,
        y: y
      });
      bigbooms.push(bigboom);
    };

    // 启动动画
    initAnimate();

  </script>
</body>
</html>
